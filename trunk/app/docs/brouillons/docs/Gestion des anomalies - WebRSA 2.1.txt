Outils de gestion des anomalies
	I) Pré-requis
		a°)
	II) Détection
		a°) Contrôleurs
		b°) Shells
	III) Correction
		a°) Contrôleurs
		b°) Shells
	IV) Statuts
		a°) Contrôleurs
		b°) Shells
			1°) gestionanomaliesbdd:
				- traductions
					* adressesSansAdressesfoyers					Enregistrements orphelins dans la table adresses (suppression de données orphelines)
					* prestationsMemeNatureEtMemeRole				Vrais doublons dans la table prestations (suppression de vrais doublons)
					* allocatairesSansCalculsdroitsrsa				Allocataires sans calcul droit RSA (ajout d'entrées )
					* allocatairesPrestationPfaSansPrestationRsa	Allocataires sans prestation RSA
					* adressesPourPlusieursAdressesfoyers			Copie des adresses appartenant à plusieurs adressesfoyers afin de rendre les enregistrements uniques
					* adressesfoyersEnDoublon						Recalcul des adresses et de leurs rangs
				- paramètre -solve
	V) Prévention
		Dans la version 2.2 (ou 2.3), on ajoutera les vérifications suivantes dans la base de données:
			a°) Corrigées grâce au shell gestionanomaliesbdd
				* adressesSansAdressesfoyers
					?
				* prestationsMemeNatureEtMemeRole (FIXME: ne pas pas dans cg66_20111110_v21, passe dans cg58_20110426_v21 et cg93_20111109_v21)
					DROP INDEX IF EXISTS prestations_personne_id_natprest_idx;
					CREATE UNIQUE INDEX prestations_personne_id_natprest_idx ON prestations (personne_id, natprest);
				* allocatairesSansCalculsdroitsrsa
					?
				* allocatairesPrestationPfaSansPrestationRsa
					?
				* adressesPourPlusieursAdressesfoyers
					DROP INDEX IF EXISTS adressesfoyers_adresse_id_idx;
					CREATE UNIQUE INDEX adressesfoyers_adresse_id_idx ON adressesfoyers (adresse_id);
				* adressesfoyersEnDoublon (FIXME: déjà fait ?)
					DROP INDEX IF EXISTS adressesfoyers_foyer_id_rgadr_idx;
					CREATE UNIQUE INDEX adressesfoyers_foyer_id_rgadr_idx ON adressesfoyers (foyer_id, rgadr);

				TODO (?):
					DROP INDEX IF EXISTS adressesfoyers_actuelle_rsa_idx;
					CREATE UNIQUE INDEX adressesfoyers_actuelle_rsa_idx ON adressesfoyers (foyer_id, rgadr) WHERE rgadr = '01';

					DROP INDEX IF EXISTS adressesfoyers_foyer_id_rgadr_idx;
					CREATE UNIQUE INDEX adressesfoyers_foyer_id_rgadr_idx ON adressesfoyers (foyer_id, rgadr);


-- -----------------------------------------------------------------------------

Personnes ayant des doublons de prestations de rôle différents:
	45@cg66_20111110_v21 (enfants, demandeurs, conjoints, ....)
	SELECT
			COUNT(DISTINCT(prestations.personne_id))
		FROM prestations
		WHERE
			prestations.id IN (
				SELECT p1.id
					FROM prestations p1,
						prestations p2
					WHERE p1.id < p2.id
						AND p1.personne_id = p2.personne_id
						AND p1.natprest = p2.natprest
						AND p1.rolepers <> p2.rolepers
			);

-- -----------------------------------------------------------------------------

Personnes sans prestation ?
	-> 28360@cg93_20111109_v21 (échantillon de 10 foyers: enfants, 2 conjoints)
	-> 85@cg66_20111110_v21
	-> 0@cg58_20110426_v21
	SELECT
			COUNT(personnes.id)
		FROM personnes
		WHERE personnes.id NOT IN (
			SELECT prestations.personne_id
				FROM prestations
				WHERE prestations.personne_id = personnes.id
		);

	SELECT
			DISTINCT(personnes.foyer_id)
		FROM personnes
		WHERE personnes.id NOT IN (
			SELECT prestations.personne_id
				FROM prestations
				WHERE prestations.personne_id = personnes.id
		)
		LIMIT 10;

-- -----------------------------------------------------------------------------

CG58:
	Enregistrements orphelins dans la table adresses                 0
	Vrais doublons dans la table prestations                         0
	Allocataires sans calcul droit RSA                               873
	Allocataires sans prestation RSA mais avec une prestation PFA    0
	Adresses appartenant à plusieurs adressesfoyers                 6196
	Adresses de même rang pour un foyer donné                      0

	Résolution: 93,64 secondes

CG66:
	Enregistrements orphelins dans la table adresses                 2
	Vrais doublons dans la table prestations                         12
	Allocataires sans calcul droit RSA                               3082
	Allocataires sans prestation RSA mais avec une prestation PFA    23
	Adresses appartenant à plusieurs adressesfoyers                 23645
	Adresses de même rang pour un foyer donné                      60

	Résolution: 427,68 secondes

CG93:
	Enregistrements orphelins dans la table adresses                 0                                                                                                                                         
	Vrais doublons dans la table prestations                         0                                                                                                                                         
	Allocataires sans calcul droit RSA                               21794                                                                                                                                     
	Allocataires sans prestation RSA mais avec une prestation PFA    0                                                                                                                                         
	Adresses appartenant à plusieurs adressesfoyers                 69529                                                                                                                                      
	Adresses de même rang pour un foyer donné                      4 

	Réssolution en 2320,18 secondes

-- -----------------------------------------------------------------------------
Nouveaux shells:
	- cake/console/cake pgsqlcake.checkmodels Personne
	- cake/console/cake pgsqlcake.maintenance (était cake/console/cake postgresql)
	- cake/console/cake gestionanomaliesbdd -solve true
-- -----------------------------------------------------------------------------
Fichiers déplacés dans le répertoire app/docs/brouillons:
	locale/fre/LC_MESSAGES/historiqueemploi.po
	locale/fre/LC_MESSAGES/objetcontratinsertion.po
	vendors/shells/class_diagram.php
	vendors/shells/graphviz.php
	vendors/shells/mpd.php
	models/historiqueemploi.php
	models/webrsa.php
	models/conditionactiviteprealable.php
	models/objetcontratinsertion.php
	models/gestionano.php
	controllers/historiqueemplois_controller.php
	controllers/gestionsanos_controller.php
	docs/gestionanos_docs.ods
	docs/gestionanos.ods
	docs/Gestion des anomalies - WebRSA 2.1.txt
	docs/dsps.sql
	docs/foreign key mess.sql
	views/historiqueemplois
	views/contratsinsertion